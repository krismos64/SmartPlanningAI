CREATE PROCEDURE SmartPlanningAI.create_vacation_notification(IN vacation_id INT, IN action_type VARCHAR(50)) BEGIN DECLARE employee_id INT; DECLARE employee_name VARCHAR(255); DECLARE start_date DATE; DECLARE end_date DATE; DECLARE vacation_type VARCHAR(50); DECLARE vacation_status VARCHAR(50); SELECT vr.employee_id, CONCAT(e.first_name, ' ', e.last_name) AS employee_name, vr.start_date, vr.end_date, vr.type, vr.status INTO employee_id, employee_name, start_date, end_date, vacation_type, vacation_status FROM vacation_requests vr JOIN employees e ON vr.employee_id = e.id WHERE vr.id = vacation_id; IF action_type = 'created' THEN INSERT INTO notifications (id, user_id, title, message, type, entity_type, entity_id, created_at) SELECT UUID(), u.id, 'Nouvelle demande de congés', CONCAT('Une nouvelle demande de congés a été soumise par ', employee_name, ' du ', DATE_FORMAT(start_date, '%d/%m/%Y'), ' au ', DATE_FORMAT(end_date, '%d/%m/%Y'), '.'), 'info', 'vacation_request', vacation_id, NOW() FROM users u WHERE u.role IN ('admin', 'manager'); ELSEIF action_type = 'approved' THEN INSERT INTO notifications (id, user_id, title, message, type, entity_type, entity_id, created_at) SELECT UUID(), u.id, 'Demande de congés approuvée', CONCAT('La demande de congés de ', employee_name, ' du ', DATE_FORMAT(start_date, '%d/%m/%Y'), ' au ', DATE_FORMAT(end_date, '%d/%m/%Y'), ' a été approuvée.'), 'success', 'vacation_request', vacation_id, NOW() FROM users u WHERE u.role IN ('admin', 'manager'); ELSEIF action_type = 'rejected' THEN INSERT INTO notifications (id, user_id, title, message, type, entity_type, entity_id, created_at) SELECT UUID(), u.id, 'Demande de congés refusée', CONCAT('La demande de congés de ', employee_name, ' du ', DATE_FORMAT(start_date, '%d/%m/%Y'), ' au ', DATE_FORMAT(end_date, '%d/%m/%Y'), ' a été refusée.'), 'error', 'vacation_request', vacation_id, NOW() FROM users u WHERE u.role IN ('admin', 'manager'); ELSEIF action_type = 'updated' THEN INSERT INTO notifications (id, user_id, title, message, type, entity_type, entity_id, created_at) SELECT UUID(), u.id, 'Demande de congés mise à jour', CONCAT('La demande de congés de ', employee_name, ' du ', DATE_FORMAT(start_date, '%d/%m/%Y'), ' au ', DATE_FORMAT(end_date, '%d/%m/%Y'), ' a été mise à jour.'), 'info', 'vacation_request', vacation_id, NOW() FROM users u WHERE u.role IN ('admin', 'manager'); END IF; END
